from bs4 import BeautifulSoup
import re
import os
import requests
import unittest
import sqlite3
import json


#Function to CALL THE API KEY
def scrape_data():
    url = "https://data.michigan.gov/resource/7frj-2rv6"
    response = requests.get(url)
    if response.status_code == 200:
        data = response.json()
        return data
    else:
        print (f"Failed to retrieve data from Michigan Government")
        return None


def set_up_database(data_name):
    path = os.path.dirname(os.path.abspath(__file__))
    #conn = sqlite3.connect('your_database.db')
    conn = sqlite3.connect(path + "/" + data_name)
    return conn

def make_database(cur, conn):

    cur.execute('''CREATE TABLE IF NOT EXISTS MI_PerCapita_PersonalIncome
                (id INTEGER PRIMARY KEY, year INETEGR, michigan_percapita_income INTEGER,
                national_percapita_income INTEGER, michigan_percapita_rank INTEGER )''')
    
    cur.execute('''CREATE TABLE IF NOT EXISTS MI_PerCapita_PersonalIncome_PercentChange
                (id INTEGER PRIMARY KEY, michigan_percent_change TEXT, national_percent_change TEXT
                michigan_percent_change_rank INTEGER)''')
    conn.commit()



    

print (scrape_data())



def main():
    data = scrape_data()
    if data:
        conn = set_up_database("personal_income.db")
        cur = conn.cursor()
        print("Data stored successfully!")

        make_database(cur, conn)


if __name__ == "__main__":
    main()
    unittest.main(verbosity=2)